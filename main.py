#!/usr/bin/python3
import subprocess
import re
import io
import requests
import csv
from packaging.version import LegacyVersion

class Programs:

    def __init__(self):
        self.__clone__()
        self.list_programs = {}
        print("Extracting softwares version from computer ...")
        data_from_command = subprocess.run(['dpkg', '-l'], stdout=subprocess.PIPE).stdout.decode('utf-8')
        data_from_command = re.sub(' +', ' ', data_from_command)
        lines = io.StringIO(data_from_command)
        # Will ignore first 5 lines 
        ignore = 5
        for line in lines:
            if ignore < 1:
                text = line.split()
                self.list_programs[text[1]] = text[2]
            else:
                ignore = ignore -1

    def __clone__(self):
        print("Cloning exploits file ...")
        response = requests.get("https://raw.githubusercontent.com/offensive-security/exploitdb/master/files_exploits.csv")
        lines = response.text.splitlines()
        reader = csv.reader(lines)
        parsed_csv = list(reader)
        self._exploits = parsed_csv

    def search_exploits(self):
        number_of_vulnerabilities_found = 0
        print("Looking for exploit ...")
        for program in self.list_programs:
            search_string = program + " "
            for exploit in self._exploits:
                if exploit[2][:len(search_string)].lower() == search_string:
                    if LegacyVersion(self.list_programs[program]) <= LegacyVersion(exploit[2]):
                        print(f"Find {search_string} in => {exploit}")
                        number_of_vulnerabilities_found = number_of_vulnerabilities_found +1
        print(f"Found {number_of_vulnerabilities_found} vulnerabilities !")


def main():
    programs = Programs()
    programs.search_exploits()

if __name__ == "__main__":
    main()
